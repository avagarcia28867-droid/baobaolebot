<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢åŒ…æœºå™¨äººç®¡ç†åå°</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { 
            background-color: #f4f6f9; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 0.95rem;
        }
        .main-container { 
            max-width: 1280px; 
            margin: 20px auto; 
            padding: 0 15px;
        }
        
        /* å¡ç‰‡æ ·å¼ä¼˜åŒ–ï¼šå¢åŠ å®çº¿è¾¹æ¡† */
        .card { 
            border: 1px solid #dcdcdc; /* æ˜æ˜¾çš„è¾¹æ¡† */
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); 
            background: white; 
            margin-bottom: 20px; 
        }
        .card-header { 
            background: #f8f9fa; 
            border-bottom: 1px solid #dcdcdc; /* æ ‡é¢˜æ åˆ†å‰²çº¿ */
            padding: 12px 20px; 
            font-weight: 600; 
            color: #495057;
            border-radius: 8px 8px 0 0 !important; 
        }

        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ–ï¼šå¢åŠ ç½‘æ ¼çº¿ */
        .table { 
            margin-bottom: 0; 
            border: 1px solid #dee2e6; /* è¡¨æ ¼æ•´ä½“è¾¹æ¡† */
        }
        .table th { 
            background-color: #e9ecef; /* è¡¨å¤´é¢œè‰²åŠ æ·± */
            color: #333; 
            font-weight: 600; 
            border-bottom: 2px solid #adb5bd;
            border-right: 1px solid #dee2e6; /* åˆ—åˆ†å‰²çº¿ */
            vertical-align: middle;
            text-align: center;
        }
        .table td { 
            vertical-align: middle; 
            padding: 10px; 
            border-right: 1px solid #dee2e6; /* åˆ—åˆ†å‰²çº¿ */
            text-align: center;
        }
        .table-hover tbody tr:hover { 
            background-color: #f1f3f5; 
        }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .badge-status { padding: 6px 10px; border-radius: 4px; font-weight: normal; font-size: 0.85em; }
        .bg-pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .bg-completed, .bg-approved { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .bg-rejected, .bg-expired { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

        /* é‡‘é¢é¢œè‰² */
        .text-in { color: #198754; font-weight: 700; }
        .text-out { color: #dc3545; font-weight: 700; }

        /* å¯¼èˆªæ  */
        .nav-pills .nav-link {
            border: 1px solid transparent;
            color: #555;
            margin-right: 5px;
            font-weight: 500;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border: 1px solid #0a58ca;
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>

<div class="main-container">
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white rounded border shadow-sm">
        <div class="d-flex align-items-center">
            <span style="font-size: 1.8rem; margin-right: 10px;">ğŸ¤–</span>
            <h4 class="mb-0 fw-bold text-dark">æœºå™¨äººç®¡ç†ç³»ç»Ÿ</h4>
        </div>
        <div>
            <span class="badge bg-secondary me-2 p-2"><i class="bi bi-shield-lock"></i> Admin</span>
            <!-- ä¿®å¤ï¼šä½¿ç”¨ location.reload() åˆ·æ–°å½“å‰é¡µï¼Œè€Œä¸æ˜¯è·³è½¬ -->
            <button onclick="location.reload()" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°é¡µé¢
            </button>
        </div>
    </div>

    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-users"><i class="bi bi-people"></i> ç”¨æˆ· & æµæ°´</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-deposits"><i class="bi bi-wallet2"></i> å……å€¼ç®¡ç†</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-withdrawals"><i class="bi bi-cash-coin"></i> æç°ç®¡ç†</button></li>
    </ul>

    <div class="tab-content">
        <!-- 1. ç”¨æˆ·åˆ—è¡¨ -->
        <div class="tab-pane fade show active" id="pills-users">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span><i class="bi bi-list-ul"></i> ç”¨æˆ·åˆ—è¡¨</span>
                    <button class="btn btn-sm btn-primary" onclick="loadUsers()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <!-- å¢åŠ  table-bordered å’Œ table-striped -->
                        <table class="table table-bordered table-striped table-hover mb-0">
                            <thead><tr><th>UID</th><th>ç”¨æˆ·å</th><th>ä½™é¢ (USDT)</th><th>é’±åŒ…åœ°å€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="users-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å……å€¼è®¢å• -->
        <div class="tab-pane fade" id="pills-deposits">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span><i class="bi bi-clock-history"></i> å……å€¼è®¢å• (æœ€æ–°)</span>
                    <button class="btn btn-sm btn-primary" onclick="loadDeposits()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover mb-0">
                            <thead><tr><th>ID</th><th>åˆ›å»ºæ—¶é—´</th><th>ç”¨æˆ·ID</th><th>é‡‘é¢ (U)</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="deposits-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. æç°è¯·æ±‚ -->
        <div class="tab-pane fade" id="pills-withdrawals">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span><i class="bi bi-box-arrow-up"></i> æç°è¯·æ±‚</span>
                    <button class="btn btn-sm btn-primary" onclick="loadWithdrawals()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover mb-0">
                            <thead><tr><th>ID</th><th>ç”¨æˆ·ID</th><th>æç°é‡‘é¢</th><th>æç°åœ°å€</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="withdrawals-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æµæ°´è¯¦æƒ… Modal -->
<div class="modal fade" id="txModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> èµ„é‡‘æµæ°´æ˜ç»†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="p-3 bg-white border-bottom">
                    <b>å½“å‰ç”¨æˆ· ID:</b> <span id="modal-uid" class="text-primary fw-bold"></span>
                </div>
                <table class="table table-bordered table-striped table-sm mb-0">
                    <thead><tr class="table-secondary"><th>æ—¶é—´</th><th>ç±»å‹</th><th>å˜åŠ¨é‡‘é¢</th><th>å¤‡æ³¨</th></tr></thead>
                    <tbody id="tx-table-body"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "/api";
    
    // æ“ä½œAPI
    async function postAction(url, body) {
        if(!confirm("âš ï¸ ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ")) return;
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if(res.ok) { 
                alert(data.message || "æ“ä½œæˆåŠŸ"); 
                loadUsers(); loadDeposits(); loadWithdrawals();
            } else { 
                alert("âŒ " + data.detail); 
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    }

    // åŠ è½½ç”¨æˆ·
    async function loadUsers() {
        const res = await fetch(`${API}/users`);
        const data = await res.json();
        const html = data.map(u => `
            <tr>
                <td><code>${u.tg_id}</code></td>
                <td>${u.username || '-'}</td>
                <td class="fw-bold text-dark">${u.balance.toFixed(2)}</td>
                <td><small class="text-muted font-monospace">${u.wallet_address ? u.wallet_address.substring(0,10)+'...' : 'æœªç»‘å®š'}</small></td>
                <td><button class="btn btn-sm btn-outline-info" onclick="viewTx(${u.tg_id})"><i class="bi bi-file-text"></i> æµæ°´</button></td>
            </tr>
        `).join('');
        document.getElementById('users-table').innerHTML = html || '<tr><td colspan="5" class="text-center text-muted py-3">æš‚æ— æ•°æ®</td></tr>';
    }

    // åŠ è½½å……å€¼
    async function loadDeposits() {
        const res = await fetch(`${API}/deposits`);
        const data = await res.json();
        const html = data.map(d => {
            let btns = '-';
            if(d.status === 'pending') {
                btns = `
                    <button class="btn btn-sm btn-success me-1" onclick="postAction('${API}/handle_deposit/${d.id}', {action:'approve'})"><i class="bi bi-check-lg"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="postAction('${API}/handle_deposit/${d.id}', {action:'reject'})"><i class="bi bi-x-lg"></i></button>
                `;
            }
            return `
            <tr>
                <td>${d.id}</td>
                <td style="font-size:0.9em">${d.created_at}</td>
                <td>${d.user_id}</td>
                <td class="fw-bold text-primary">${d.real_pay.toFixed(2)}</td>
                <td><span class="badge badge-status bg-${d.status}">${d.status}</span></td>
                <td>${btns}</td>
            </tr>`;
        }).join('');
        document.getElementById('deposits-table').innerHTML = html || '<tr><td colspan="6" class="text-center text-muted py-3">æš‚æ— è®¢å•</td></tr>';
    }

    // åŠ è½½æç°
    async function loadWithdrawals() {
        const res = await fetch(`${API}/withdrawals`);
        const data = await res.json();
        const html = data.map(w => {
            let btns = '-';
            if(w.status === 'pending') {
                btns = `
                    <button class="btn btn-sm btn-success me-1" onclick="postAction('${API}/handle_withdrawal/${w.id}', {action:'approve'})"><i class="bi bi-check-lg"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="postAction('${API}/handle_withdrawal/${w.id}', {action:'reject'})"><i class="bi bi-x-lg"></i></button>
                `;
            }
            return `
            <tr>
                <td>${w.id}</td>
                <td>${w.user_id}</td>
                <td class="fw-bold text-danger">${w.amount.toFixed(2)}</td>
                <td style="font-size:0.9em">${w.wallet_address}</td>
                <td><span class="badge badge-status bg-${w.status}">${w.status}</span></td>
                <td>${btns}</td>
            </tr>`;
        }).join('');
        document.getElementById('withdrawals-table').innerHTML = html || '<tr><td colspan="6" class="text-center text-muted py-3">æš‚æ— è¯·æ±‚</td></tr>';
    }

    // æŸ¥çœ‹æµæ°´ (å¼¹çª—)
    async function viewTx(uid) {
        document.getElementById('modal-uid').innerText = uid;
        // æ¸…ç©ºæ—§æ•°æ®
        document.getElementById('tx-table-body').innerHTML = '<tr><td colspan="4" class="text-center">åŠ è½½ä¸­...</td></tr>';
        
        try {
            const res = await fetch(`${API}/transactions/${uid}`);
            const data = await res.json();
            
            const html = data.map(tx => {
                const isInc = tx.amount > 0;
                return `
                <tr>
                    <td style="font-size:0.9em">${tx.time}</td>
                    <td>${tx.type}</td>
                    <td class="${isInc ? 'text-in' : 'text-out'}">${isInc ? '+' : ''}${tx.amount.toFixed(2)}</td>
                    <td style="font-size:0.9em">${tx.note || '-'}</td>
                </tr>`;
            }).join('');
            document.getElementById('tx-table-body').innerHTML = html || '<tr><td colspan="4" class="text-center py-3">æš‚æ— æµæ°´</td></tr>';
        } catch(e) {
            document.getElementById('tx-table-body').innerHTML = '<tr><td colspan="4" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
        }
        
        new bootstrap.Modal(document.getElementById('txModal')).show();
    }

    // åˆå§‹åŒ–
    loadUsers(); loadDeposits(); loadWithdrawals();
</script>
</body>
</html>